---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import BlogCard from "../../components/BlogCard.astro";
import { BookOpen, Search, Tag } from "lucide-astro";
import { getCollection } from "astro:content";

const title = "Blog Technique | E Informatique — Articles Dev, Sécurité & Infrastructure";
const description = "Articles techniques sur le développement web, la cybersécurité, le DevOps et la performance. Conseils pratiques et guides détaillés par un développeur freelance.";

// Get all blog posts, filter out drafts, and sort by date (newest first)
const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const blogPosts = allPosts.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// Get unique categories
const allCategories = [...new Set(blogPosts.map(post => post.data.category))];
const categories = ["Tous", ...allCategories.sort()];

// Helper function to format dates
function formatDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString("fr-FR", {
    day: "numeric",
    month: "long",
    year: "numeric",
  });
}
---

<BaseLayout title={title} description={description}>
    <Header />

    <main class="pt-24 md:pt-32">
        <!-- Hero Section -->
        <section class="py-12 md:py-20">
            <div class="container-custom">
                <div class="text-center max-w-3xl mx-auto mb-12 md:mb-16">
                    <div class="w-14 h-14 rounded-xl bg-primary-600/10 flex items-center justify-center mx-auto mb-4 reveal">
                        <BookOpen class="w-7 h-7 text-primary-400" />
                    </div>
                    <h1 class="section-title text-main reveal">
                        Blog <span class="text-highlight">technique</span>
                    </h1>
                    <p class="text-secondary max-w-2xl mx-auto reveal delay-100">
                        Guides pratiques, retours d'expérience et astuces sur le développement web, 
                        la cybersécurité, le DevOps et la performance. Du concret, pas du bla-bla.
                    </p>
                </div>

                <!-- Category Filter -->
                <div class="flex flex-wrap justify-center gap-3 mb-12 reveal delay-200" id="category-filter">
                    {
                        categories.map((cat, i) => (
                            <button
                                class={`px-4 py-2 rounded-full text-sm font-medium transition-all duration-300 border cursor-pointer ${
                                    i === 0
                                        ? "bg-primary-600 text-white border-primary-500 shadow-[0_0_15px_rgba(var(--color-primary-500),0.3)]"
                                        : "bg-dark-800 text-secondary border-dark-600 hover:border-primary-500/50 hover:text-main"
                                }`}
                                data-category={cat}
                            >
                                {cat}
                            </button>
                        ))
                    }
                </div>

                <!-- Blog Grid -->
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8" id="blog-grid">
                    {
                        blogPosts.map((post) => (
                            <div data-post-category={post.data.category}>
                                <BlogCard
                                    slug={post.slug}
                                    title={post.data.title}
                                    excerpt={post.data.excerpt}
                                    date={post.data.date}
                                    readTime={post.data.readTime}
                                    category={post.data.category}
                                    tags={post.data.tags}
                                />
                            </div>
                        ))
                    }
                </div>

                <!-- Empty State -->
                <div class="hidden text-center py-16" id="empty-state">
                    <div class="w-16 h-16 rounded-full bg-dark-800 flex items-center justify-center mx-auto mb-4">
                        <Search class="w-8 h-8 text-secondary" />
                    </div>
                    <h3 class="text-xl font-bold text-main mb-2">Aucun article trouvé</h3>
                    <p class="text-secondary">Pas encore d'article dans cette catégorie. Revenez bientôt !</p>
                </div>
            </div>
        </section>

        <!-- Newsletter / CTA Section -->
        <section class="py-16 md:py-24 bg-dark-900">
            <div class="container-custom">
                <div class="glass-card p-8 md:p-12 text-center max-w-2xl mx-auto reveal">
                    <div class="w-12 h-12 rounded-xl bg-primary-600/10 flex items-center justify-center mx-auto mb-4">
                        <Tag class="w-6 h-6 text-primary-400" />
                    </div>
                    <h2 class="text-2xl md:text-3xl font-bold text-main mb-4">
                        Un projet technique en tête ?
                    </h2>
                    <p class="text-secondary mb-6">
                        Que vous ayez besoin d'un site performant, d'une infrastructure sécurisée 
                        ou d'un audit technique, je suis là pour vous accompagner.
                    </p>
                    <a href="/contact" class="btn-primary inline-flex hover:scale-105 active:scale-95 transition-all duration-300 shadow-[0_0_15px_rgba(var(--color-primary-500),0.3)] hover:shadow-[0_0_25px_rgba(var(--color-primary-500),0.5)]">
                        Discutons de votre projet
                    </a>
                </div>
            </div>
        </section>
    </main>

    <Footer />
</BaseLayout>

<script>
    // Category filter functionality
    const filterButtons = document.querySelectorAll("#category-filter button");
    const blogGrid = document.getElementById("blog-grid");
    const emptyState = document.getElementById("empty-state");
    const postCards = document.querySelectorAll("#blog-grid > div[data-post-category]");

    filterButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
            const category = btn.getAttribute("data-category");

            // Update active button
            filterButtons.forEach((b) => {
                b.classList.remove("bg-primary-600", "text-white", "border-primary-500", "shadow-[0_0_15px_rgba(var(--color-primary-500),0.3)]");
                b.classList.add("bg-dark-800", "text-secondary", "border-dark-600");
            });
            btn.classList.remove("bg-dark-800", "text-secondary", "border-dark-600");
            btn.classList.add("bg-primary-600", "text-white", "border-primary-500", "shadow-[0_0_15px_rgba(var(--color-primary-500),0.3)]");

            // Filter posts
            let visibleCount = 0;
            postCards.forEach((card) => {
                const postCategory = card.getAttribute("data-post-category");
                if (category === "Tous" || postCategory === category) {
                    (card as HTMLElement).style.display = "";
                    visibleCount++;
                } else {
                    (card as HTMLElement).style.display = "none";
                }
            });

            // Toggle empty state
            if (visibleCount === 0) {
                emptyState?.classList.remove("hidden");
                blogGrid?.classList.add("hidden");
            } else {
                emptyState?.classList.add("hidden");
                blogGrid?.classList.remove("hidden");
            }
        });
    });
</script>
