---
import { Sun, Moon } from "lucide-astro";
---

<button
    aria-label="Toggle theme"
    class="theme-toggle-btn relative p-2 rounded-lg text-secondary hover:bg-dark-800 transition-colors focus:outline-none cursor-pointer overflow-hidden"
>
    <div class="relative w-6 h-6 flex items-center justify-center">
        <!-- Sun Icon (Shows when Dark - to switch to Light) -->
        <span
            class="icon-sun absolute inset-0 flex items-center justify-center transition-all duration-500 ease-[cubic-bezier(0.23,1,0.32,1)]"
        >
            <Sun class="w-5 h-5 text-yellow-500" />
        </span>

        <!-- Moon Icon (Shows when Light - to switch to Dark) -->
        <span
            class="icon-moon absolute inset-0 flex items-center justify-center transition-all duration-500 ease-[cubic-bezier(0.23,1,0.32,1)]"
        >
            <Moon class="w-5 h-5 text-primary-600" />
        </span>
    </div>
</button>

<style>
    /* PRECISE LOGIC:
       Default (Dark Theme):
       - We want to show the SUN (to switch to Light).
       - Sun: Scale 1, Rotate 0
       - Moon: Scale 0, Rotate -90deg (hidden)
       
       Light Theme (data-theme="light"):
       - We want to show the MOON (to switch to Dark).
       - Sun: Scale 0, Rotate 90deg (hidden)
       - Moon: Scale 1, Rotate 0
    */

    /* Default (Dark) State */
    .icon-sun {
        transform: rotate(0deg) scale(1);
        opacity: 1;
    }
    .icon-moon {
        transform: rotate(-90deg) scale(0);
        opacity: 0;
    }

    /* Light Theme Override */
    :global(html[data-theme="light"]) .icon-sun {
        transform: rotate(90deg) scale(0);
        opacity: 0;
    }
    :global(html[data-theme="light"]) .icon-moon {
        transform: rotate(0deg) scale(1);
        opacity: 1;
    }
</style>

<script is:inline>
    (() => {
        // Function to get current theme
        function getTheme() {
            if (
                typeof localStorage !== "undefined" &&
                localStorage.getItem("theme")
            ) {
                return localStorage.getItem("theme");
            }
            if (window.matchMedia("(prefers-color-scheme: light)").matches) {
                return "light";
            }
            return "dark"; // Default
        }

        // Function to set theme
        function setTheme(theme) {
            if (theme === "light") {
                document.documentElement.setAttribute("data-theme", "light");
            } else {
                document.documentElement.removeAttribute("data-theme");
            }
            localStorage.setItem("theme", theme);
        }

        // Initialize theme once (idempotent, safe to run multiple times)
        const currentTheme = getTheme();
        setTheme(currentTheme);

        // Setup listeners for all buttons
        function setupButtons() {
            const buttons = document.querySelectorAll(".theme-toggle-btn");
            buttons.forEach((btn) => {
                if (btn.hasAttribute("data-theme-init")) return;
                btn.setAttribute("data-theme-init", "true");

                btn.addEventListener("click", () => {
                    const isLight =
                        document.documentElement.getAttribute("data-theme") ===
                        "light";
                    setTheme(isLight ? "dark" : "light");
                });
            });
        }

        setupButtons();

        // Listen for view transitions (Astro specific navigation)
        document.addEventListener("astro:after-swap", () => {
            const storedTheme = getTheme();
            setTheme(storedTheme);
            setupButtons();
        });

        // Handle system preference change - ensure we only add this listener once globally ideally,
        // but adding multiple identical listeners to matchMedia is rare/ok?
        // Better to check if we already handled it?
        // Given this script runs per instance, we might add multiple listeners.
        // For simplicity, let's leave it as is, or use a global flag.
        if (!window.__themeSystemListenerAdded) {
            window
                .matchMedia("(prefers-color-scheme: light)")
                .addEventListener("change", (e) => {
                    if (!localStorage.getItem("theme")) {
                        setTheme(e.matches ? "light" : "dark");
                    }
                });
            window.__themeSystemListenerAdded = true;
        }
    })();
</script>
